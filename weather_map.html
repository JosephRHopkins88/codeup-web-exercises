<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
    <script src="js/mapbox-geocoder-utils.js"></script>
    <script src="js/weather_map.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet'/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">


    <script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
    <style>

        body {
            background-color: lightskyblue;
            color: #404040;
            font: 400 15px/22px 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        .map {
            position: absolute;
            top: 68%;
            width: 100%;
            bottom: 0;
        }

        h1 {
            font-size: xxx-large;
            background-color: #1c6db3;
            font-weight: bold;
            color: whitesmoke;
            font-style: italic;
            margin: 0;
            line-height: 20px;
            padding: 20px 2px;
        }

        .card-body {
            background-color: #1c6db3;
            color: white;
            align-items: center;
        }

        #currentCity {
            text-align: right;
            font-size: x-large;
            margin-right: 40px;
        }

        .row {
            justify-content: space-evenly;
            margin-top: 8px;
        }

        #search {
            margin: -20px 1100px 0 40px;
        }

    </style>
</head>
<body>

<h1>Weather App</h1>

<br>

<!--this gives me the current city listed on the page-->
<div id="currentCity"></div>

<!--this gives me the search bar and the button-->
<form action="weather_map.html" method="get" id="search">
    <input class="form-control mr-sm-2" type="search" placeholder="City and State" aria-label="Search" id="txtSearch" name="txtSearch">
    <button class="btn btn-outline-secondary my-2 my-sm-0" type="submit">Search</button>
</form>

<!--makes cards to store my weather information in and display it on the page-->
<div class="row" id="weather_row" style="display:none;">
    <div class="card col-2">
        <div class="card-body">
            <h4 id="todayDate0" class="card-title"></h4>
            <div id="icon0" class="card-text"></div>
            <div id="temp0" class="card-text"></div>
            <div id="wind_speed0" class="card-text"></div>
            <div id="sunrise0" class="card-text"></div>
            <div id="sunset0" class="card-text"></div>
        </div>
    </div>
    <div class="card col-2">
        <div class="card-body">
            <h4 id="todayDate1" class="card-title"></h4>
            <div id="icon1" class="card-text"></div>
            <div id="temp1" class="card-text"></div>
            <div id="wind_speed1" class="card-text"></div>
            <div id="sunrise1" class="card-text"></div>
            <div id="sunset1" class="card-text"></div>
        </div>
    </div>
    <div class="card col-2">
        <div class="card-body">
            <h4 id="todayDate2" class="card-title"></h4>
            <div id="icon2" class="card-text"></div>
            <div id="temp2" class="card-text"></div>
            <div id="wind_speed2" class="card-text"></div>
            <div id="sunrise2" class="card-text"></div>
            <div id="sunset2" class="card-text"></div>
        </div>
    </div>
    <div class="card col-2">
        <div class="card-body">
            <h4 id="todayDate3" class="card-title"></h4>
            <div id="icon3" class="card-text"></div>
            <div id="temp3" class="card-text"></div>
            <div id="wind_speed3" class="card-text"></div>
            <div id="sunrise3" class="card-text"></div>
            <div id="sunset3" class="card-text"></div>
        </div>
    </div>
    <div class="card col-2">
        <div class="card-body">
            <h4 id="todayDate4" class="card-title"></h4>
            <div id="icon4" class="card-text"></div>
            <div id="temp4" class="card-text"></div>
            <div id="wind_speed4" class="card-text"></div>
            <div id="sunrise4" class="card-text"></div>
            <div id="sunset4" class="card-text"></div>
        </div>
    </div>
</div>


<div id="map" class="map"></div>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="js/keys.js"></script>
<script>


    let urlParams = new URLSearchParams(window.location.search);
    let searchText = urlParams.get('txtSearch');

    //if my search text is empty or my search text has nothing written after it then this defaults to location of San Antonio
    if(searchText===null || searchText.length===0)
    {
        searchText="San Antonio, Texas";
    }

//document.getElementById("txtSearch").value = searchText;

    document.getElementById("currentCity").innerHTML = searchText;

    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;

    //this is controlling my entire search. it is grabbing a response and if that response if filled it is sending back the information needed.
    var mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });
    mapboxClient.geocoding
        .forwardGeocode({
            query: searchText,
            autocomplete: false,
            limit: 1
        })
        .send()
        .then(function (response) {
            if (
                response &&
                response.body &&
                response.body.features &&
                response.body.features.length
            ) {
                var feature = response.body.features[0];
console.log(feature);
                //this is what is giving me my map
                var map = new mapboxgl.Map({
                        container: 'map', // container ID
                        style: 'mapbox://styles/mapbox/streets-v11', // style URL
                        center: feature.center,//[-98.493629, 29.424122], // starting position [lng, lat]
                        zoom: 9, // starting zoom

                    });

                //this is giving me my marker and it is being told where to set. in this case center
                const marker = new mapboxgl.Marker({color: 'red'}).setLngLat([feature.center[0],feature.center[1]]).addTo(map);
                const popup = new mapboxgl.Popup().setLngLat([feature.center[0],feature.center[1]]).addTo(map);
                marker.setPopup(popup);
                //get the weather from the starting location
                getWeatherInfo(marker,popup);
                marker.setDraggable(true);
                marker.on('dragend', function () {
                    //get the name of the city we dragged onto
                    getCityName(marker,popup);
                    //get the weather from wherever we dragged the marker to
                    getWeatherInfo(marker,popup);
                })

            }})


    function getCityName(marker,popup)
    {
        //alert("getting city name");
        var lngLat = marker.getLngLat();
        var coordinates = [lngLat.lat, lngLat.lng];
        //this is getting the coordinates and turning it into a location
        mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
        var mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });
        mapboxClient.geocoding
            .reverseGeocode({
                query: [coordinates[1],coordinates[0]]
            })
            .send()
            .then(function (response) {
                //console.log("hello 1: " + response.body.features);
                if (
                    response &&
                    response.body &&
                    response.body.features &&
                    response.body.features.length
                ) {
                   var feature = response.body.features[0];
                    //console.log("hello: " + parseReverseGeo(feature));

                    document.getElementById("currentCity").innerHTML = parseReverseGeo(feature);
                }
            })
    }

    //this is going through the context and fining certain aspects to display back.
    function parseReverseGeo(geoData) {
        // debugger;
        var region, countryName, place, returnStr;
        if(geoData.context){
            $.each(geoData.context, function(i, v){
                //console.log(v.id + " - " + v.text);
                if(v.id.indexOf('place') >= 0) {
                    place = v.text;
                }
                else if(v.id.indexOf('region') >= 0) {
                    region = v.text;
                }
                else if(v.id.indexOf('country') >= 0) {
                    countryName = v.text;
                }
            });
        }
        if(place && region && countryName) {
            returnStr = place + ", " + region + ", " + countryName;
        } else {
            returnStr = geoData.place_name;
        }
        return returnStr;
    }

    function getWeatherInfo(marker,popup)
    {
        //this is taking the coordiantes and finding the weather for the location. Then it is getting each element that is called so that i can display them into a div. it is also converting the time and date into readable text not just numbers. this is also where the icons are being called.
        var lngLat = marker.getLngLat();
        var coordinates = [lngLat.lat, lngLat.lng];
        popup.setHTML('Coordinates: ' + lngLat.lat.toFixed(2) + ',' + lngLat.lng.toFixed(2));
        $.get("https://api.openweathermap.org/data/2.5/onecall?units=imperial&lat=" + coordinates[0] + "&lon=" + coordinates[1] + "&exclude=current,hourly,minutely&appid=" + WEATHER_MAP_TOKEN)
            .done(function (resp) {
                console.log(resp);
                //var today = resp.daily[0];
                //var todayDate = new Date(today.dt * 1000);
                //console.log(todayDate);
                for (var i = 0; i < 5; i++) {
                    document.getElementById("todayDate" + i).innerHTML = new Date(resp.daily[i].dt*1000).toDateString();
                    document.getElementById("icon" + i).innerHTML = "<img src='http://openweathermap.org/img/wn/" + resp.daily[i].weather[0].icon + "@2x.png' alt='The weather icon'/>";
                    document.getElementById("temp" + i).innerHTML = "Temperature:<br/>Morning:" + resp.daily[i].temp.morn.toFixed(0) + "<br/>Day:" + resp.daily[i].temp.day.toFixed(0) + "<br/>Evening:" + resp.daily[i].temp.eve.toFixed(0) + "<br/>Night:" + resp.daily[i].temp.night.toFixed(0) + "<br/>Min:" + resp.daily[i].temp.min.toFixed(0) + "<br/>Max:" + resp.daily[i].temp.max.toFixed(0);
                    document.getElementById("wind_speed" + i).innerHTML = "Wind speed: " + resp.daily[i].wind_speed;
                    document.getElementById("sunrise" + i).innerHTML = "Sunrise: " + new Date(resp.daily[i].sunrise*1000).toLocaleTimeString();
                    document.getElementById("sunset" + i).innerHTML = "Sunset: " + new Date(resp.daily[i].sunset*1000).toLocaleTimeString();
                }
                if (resp.daily.length > 0) {
                    document.getElementById("weather_row").style.display = "flex";
                }
            });
    }
</script>
</body>
</html>
